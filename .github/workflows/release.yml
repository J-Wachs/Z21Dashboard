name: Build and Release

on:
  # Trigger on push of tags matching v*, e.g., v1.0.0
  push:
    tags:
      - 'v*'
  # Allows manual testing via Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    # 1. Checkout code (Fetch submodules recursively)
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 2. Setup .NET 9
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    # 3. Run Unit Tests
    - name: Run Unit Tests
      run: dotnet test --configuration Release

    # 4. Build and Publish App
    # Output goes to './publish' which is used for Inno Setup
    - name: Publish App
      run: dotnet publish Z21Dashboard/Z21Dashboard.csproj -f net9.0-windows10.0.19041.0 -c Release -r win-x64 --self-contained true -o ./publish

    # 5. Create ZIP file with specific structure (Subfolder + License)
    - name: Create Zip file
      run: |
        # Create a staging directory
        New-Item -Path ./TempZip/Z21Dashboard -ItemType Directory -Force
        
        # Copy published app files into the subfolder
        Copy-Item -Path ./publish/* -Destination ./TempZip/Z21Dashboard -Recurse
        
        # Copy license file to the root of the staging directory
        # (Assumes LICENSE.txt exists in the root of your repository)
        Copy-Item -Path ./LICENSE.txt -Destination ./TempZip/LICENSE.txt
        
        # Zip the staging directory contents
        Compress-Archive -Path ./TempZip/* -DestinationPath ./Z21Dashboard.zip

    # 6. Compile Installer (Chocolatey method)
    # Note: We still use 'publish' folder implicitly via the .iss file
    - name: Compile Installer
      run: |
        choco install innosetup --no-progress
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup_script.iss

    # 7. Create GitHub Release
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Z21Dashboard.zip
          Output/Z21DashboardSetup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
