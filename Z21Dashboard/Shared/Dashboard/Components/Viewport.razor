@*
    Viewport.razor
    A Blazor component that serves as a dynamic dashboard viewport, allowing users to drag and drop various widgets.
    It manages the layout and state of the dashboard components, ensuring they are rendered correctly based on user interactions.
*@
@using Microsoft.AspNetCore.Components.Web
@using Z21Client.Models
@using Z21Dashboard.Application.Interfaces
@using Z21Dashboard.Application.Models
@using Z21Dashboard.Shared.Dashboard.Widgets
@implements IDisposable
@inject IDashboardStateService DashboardStateService

<div class="dashboard-canvas @DragClass"
     style="position: relative; min-height: 2000px; min-width: 2000px;"
     @onmousemove="HandleMouseMove"
     @onmouseup="HandleMouseUp">

    @foreach (var componentState in VisibleComponents)
    {
        <div @key="componentState.Id" class="absolute-item"
             style="@GetAbsoluteItemStyle(componentState)">
            <DynamicComponent Type="@(componentState.ComponentType!)" Parameters="@componentState.Parameters" />
        </div>
    }
</div>


@code {
    [Parameter]
    public HardwareInfo? HardwareInfo { get; set; }
    [Parameter]
    public Z21Code? Z21Code { get; set; }

    private List<DashboardComponentState> VisibleComponents { get; set; } = new();
    private DashboardComponentState? _draggedComponent;
    private bool _isDragging = false;
    private double _dragOffsetX = 0;
    private double _dragOffsetY = 0;

    // A computed property to apply a CSS class only during a drag operation.
    private string DragClass => _isDragging ? "no-select" : string.Empty;

    protected override void OnInitialized()
    {
        DashboardStateService.OnLayoutChanged += OnLayoutChanged;
        LoadVisibleComponents();
    }

    protected override void OnParametersSet()
    {
        UpdateComponentParameters();
    }

    private async void OnLayoutChanged()
    {
        await InvokeAsync(() =>
        {
            LoadVisibleComponents();
            StateHasChanged();
        });
    }

    private void LoadVisibleComponents()
    {
        VisibleComponents = DashboardStateService.GetVisibleComponentStates();
        UpdateComponentParameters();
    }

    private void HandleMouseDown(DashboardComponentState component, MouseEventArgs args)
    {
        _isDragging = true;
        _draggedComponent = component;
        _dragOffsetX = args.ClientX - component.PositionX;
        _dragOffsetY = args.ClientY - component.PositionY;
        BringToFront(component);
    }

    private void BringToFront(DashboardComponentState component)
    {
        if (component.ZIndex >= GetHighestZIndex() && VisibleComponents.Count > 1)
        {
            return;
        }

        component.ZIndex = GetHighestZIndex() + 1;
        StateHasChanged();
    }


    private void HandleMouseMove(MouseEventArgs args)
    {
        if (!_isDragging || _draggedComponent == null) return;
        var newX = (int)(args.ClientX - _dragOffsetX);
        var newY = (int)(args.ClientY - _dragOffsetY);
        _draggedComponent.PositionX = newX > 0 ? newX : 0;
        _draggedComponent.PositionY = newY > 0 ? newY : 0;
        StateHasChanged();
    }

    private async void HandleMouseUp()
    {
        if (!_isDragging || _draggedComponent == null) return;
        NormalizeZIndexes();
        var allComponents = DashboardStateService.GetComponentStates();
        var componentToUpdate = allComponents.FirstOrDefault(c => c.Id == _draggedComponent.Id);
        if (componentToUpdate != null)
        {
            componentToUpdate.PositionX = _draggedComponent.PositionX;
            componentToUpdate.PositionY = _draggedComponent.PositionY;
            componentToUpdate.ZIndex = _draggedComponent.ZIndex;
        }
        await DashboardStateService.UpdateLayout(allComponents);
        _isDragging = false;
        _draggedComponent = null;
    }

    private string GetAbsoluteItemStyle(DashboardComponentState state)
    {
        var style = $"position: absolute; " +
                    $"left: {state.PositionX}px; " +
                    $"top: {state.PositionY}px; " +
                    $"width: {state.Width}px; " +
                    $"z-index: {state.ZIndex};";

        if (_isDragging && _draggedComponent?.Id == state.Id)
        {
            style += " user-select: none; opacity: 0.7; pointer-events: none;";
        }

        if (state.Height > 0)
        {
            style += $" height: {state.Height}px;";
        }
        return style;
    }

    private void UpdateComponentParameters()
    {
        foreach (var state in VisibleComponents)
        {
            var parameters = new Dictionary<string, object>
            {
                ["OnHeaderMouseDown"] = new EventCallback<MouseEventArgs>(this, (MouseEventArgs args) => HandleMouseDown(state, args)),
                ["OnBringToFront"] = new EventCallback(this, () => BringToFront(state))
            };

            // Check for components needing 'FirmwareVersion'.
            if (state.ComponentType == typeof(LocoListOperationTimeView) ||
                state.ComponentType == typeof(LocoListView) ||
                state.ComponentType == typeof(LocoSlotView) ||
                state.ComponentType == typeof(LocoControl) ||
                state.ComponentType == typeof(LocoControl2))
            {
                if (HardwareInfo?.FwVersion is not null)
                {
                    parameters["FirmwareVersion"] = HardwareInfo.FwVersion;
                }
            }
            else if (state.ComponentType == typeof(SystemStateView) ||
                     state.ComponentType == typeof(SystemStateFullView))
            {
                if (HardwareInfo is not null)
                {
                    parameters["HardwareInfo"] = HardwareInfo;
                }
            }
            if (state.ComponentType == typeof(LocoListOperationTimeView) ||
                state.ComponentType == typeof(LocoControl) ||
                state.ComponentType == typeof(LocoControl2))
            {
                if (Z21Code is not null)
                {
                    parameters["Z21Code"] = Z21Code;
                }

            }

            state.Parameters = parameters;
        }
    }

    private int GetHighestZIndex()
    {
        if (!VisibleComponents.Any())
            return 1;
        return VisibleComponents.Max(c => c.ZIndex);
    }

    private void NormalizeZIndexes()
    {
        var orderedByZ = VisibleComponents.OrderBy(c => c.ZIndex).ToList();
        for (int i = 0; i < orderedByZ.Count; i++)
        {
            orderedByZ[i].ZIndex = i + 1;
        }
    }
    public void Dispose()
    {
        DashboardStateService.OnLayoutChanged -= OnLayoutChanged;
    }
}
