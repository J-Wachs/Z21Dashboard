@*
    A simple Blazor component to render a line chart using SVG.
    This component draws a line through the data points and displays tooltips on hover.
*@
@using System.Globalization
@using System.Text
@using Z21Dashboard.Application.Models

<div class="line-chart-container" style="max-width: @(Width)px;">
    <h4>@Title</h4>
    <svg width="@Width" height="@Height" viewBox="0 0 @Width @Height">
        <!-- Axes -->
        <line x1="@Margin" y1="@(Height - Margin)" x2="@(Width - Margin)" y2="@(Height - Margin)" stroke="gray" />
        <line x1="@Margin" y1="@Margin" x2="@Margin" y2="@(Height - Margin)" stroke="gray" />

        <!-- Axis Titles -->
        <text x="@(Width / 2)" y="@(Height - 5)" text-anchor="middle" font-size="14">@XAxisTitle</text>
        <text transform="translate(15, @(Height / 2)) rotate(-90)" text-anchor="middle" font-size="14">@YAxisTitle</text>

        <!-- The line itself - the primary addition -->
        @if (!string.IsNullOrEmpty(_polylinePoints))
        {
            <polyline points="@_polylinePoints"
                      fill="none"
                      stroke="@LineColor"
                      stroke-width="@LineWidth" />
        }

        <!-- Data points (circles) - still useful for tooltips -->
        @if (Data != null)
        {
            foreach (var point in Data)
            {
                <circle cx="@MapX(point.X)"
                        cy="@MapY(point.Y)"
                        r="@PointRadius"
                        fill="@PointColor"
                        stroke="white"
                        stroke-width="1"
                        onmouseover="@(() => ShowTooltip(point))"
                        onmouseout="@HideTooltip" />
            }
        }

        <!-- Tooltip -->
        @if (_hoveredPoint != null)
        {
            <g transform="translate(@_tooltipX, @_tooltipY)">
                <rect x="5" y="-25" width="120" height="25" fill="rgba(255, 255, 220, 0.9)" stroke="black" rx="3" />
                <text x="10" y="-8" font-size="12">
                    @(_hoveredPoint.Label ?? $"({Format(_hoveredPoint.X)}, {Format(_hoveredPoint.Y)})")
                </text>
            </g>
        }

    </svg>
</div>

@code {
    [Parameter] public List<DataPoint> Data { get; set; } = new();
    [Parameter] public string Title { get; set; } = "Line Chart";
    [Parameter] public string XAxisTitle { get; set; } = "X-Axis";
    [Parameter] public string YAxisTitle { get; set; } = "Y-Axis";

    [Parameter] public int Width { get; set; } = 600;
    [Parameter] public int Height { get; set; } = 400;
    [Parameter] public int Margin { get; set; } = 40;

    // Styling for points and line
    [Parameter] public int PointRadius { get; set; } = 5;
    [Parameter] public string PointColor { get; set; } = "crimson";
    [Parameter] public string LineColor { get; set; } = "crimson";
    [Parameter] public int LineWidth { get; set; } = 2;

    private double _minX, _maxX, _minY, _maxY;
    private string _polylinePoints = "";

    // Tooltip state
    private DataPoint? _hoveredPoint;
    private double _tooltipX, _tooltipY;

    protected override void OnParametersSet()
    {
        if (Data == null || !Data.Any())
        {
            _minX = _maxX = _minY = _maxY = 0;
            _polylinePoints = "";
            return;
        }

        // IMPORTANT for a line chart: Sort the data by the X-axis!
        var sortedData = Data.OrderBy(p => p.X).ToList();

        _minX = sortedData.Min(p => p.X);
        _maxX = sortedData.Max(p => p.X);
        _minY = sortedData.Min(p => p.Y);
        _maxY = sortedData.Max(p => p.Y);

        if (_maxX == _minX) _maxX += 1;
        if (_maxY == _minY) _maxY += 1;

        // Generate the points for the <polyline>
        GeneratePolylinePoints(sortedData);
    }

    private void GeneratePolylinePoints(List<DataPoint> sortedData)
    {
        if (sortedData.Count < 2)
        {
            _polylinePoints = "";
            return;
        }

        // Builds a string like "x1,y1 x2,y2 x3,y3 ..."
        var sb = new StringBuilder();
        foreach (var point in sortedData)
        {
            // Use InvariantCulture to ensure the decimal separator is a period ('.')
            sb.Append(MapX(point.X).ToString(CultureInfo.InvariantCulture));
            sb.Append(',');
            sb.Append(MapY(point.Y).ToString(CultureInfo.InvariantCulture));
            sb.Append(' ');
        }
        _polylinePoints = sb.ToString().Trim();
    }

    // These methods are unchanged from the Scatter Plot
    private double MapX(double dataX)
    {
        double plotWidth = Width - 2 * Margin;
        double normalizedX = (_maxX == _minX) ? 0 : (dataX - _minX) / (_maxX - _minX);
        return Margin + normalizedX * plotWidth;
    }

    private double MapY(double dataY)
    {
        double plotHeight = Height - 2 * Margin;
        double normalizedY = (_maxY == _minY) ? 0 : (dataY - _minY) / (_maxY - _minY);
        return (Height - Margin) - normalizedY * plotHeight;
    }

    private void ShowTooltip(DataPoint point)
    {
        _hoveredPoint = point;
        _tooltipX = MapX(point.X);
        _tooltipY = MapY(point.Y);
    }

    private void HideTooltip() => _hoveredPoint = null;

    private string Format(double value) => value.ToString("F1", CultureInfo.InvariantCulture);
}