@*
    Displays a list of active locomotives with their details.
*@
@using System.Text
@using Microsoft.AspNetCore.Components.Web
@using Z21Client.Helpers
@using Z21Client.Infrastructure
@using Z21Client.Interfaces
@using Z21Client.Models
@using Z21Dashboard.Application.Interfaces
@using Z21Dashboard.Application.Models
@using Z21Dashboard.Helpers
@using Z21Dashboard.Shared.Dashboard.Components
@inject IZ21Client Z21Client
@inject ILocoMetadataService LocoMetadataService
@implements IDisposable

<DashboardWindow HeaderTitle="Active Locomotives"
                 OnHeaderMouseDown="OnHeaderMouseDown"
                 OnBringToFront="OnBringToFront">
    <Content>
        <div class="table-container-sticky-header">
            <table class="table table-hover table-bordered table-striped table-sm">
                <thead class="sticky-top">
                    <tr>
                        <th>Address</th>
                        @if (FirmwareVersion?.Version >= Z21FirmwareVersions.V1_20)
                        {
                            <th>Protocol</th>
                        }
                        <th><span title="Direction">D</span></th>
                        <th>Speed</th>
                        <th>Functions</th>
                        <th>Last changed</th>
                    </tr>
                </thead>
                <tbody>
                    @if (activeLocos.Any())
                    {
                        @foreach (var locoDisplay in activeLocos.Values.OrderBy(l => l.Info.Address))
                        {
                            <tr>
                                <td><strong>@LocoMetadataService.GetDisplayName(locoDisplay.Info.Address)</strong></td>
                                @if (FirmwareVersion?.Version >= Z21FirmwareVersions.V1_20)
                                {
                                    <td>@locoDisplay.DisplayProtocol</td>
                                }
                                <td>
                                    @if (locoDisplay.Info.Direction is DrivingDirection.Forward)
                                    {
                                        <span style="font-weight: bold;" title="Forward">
                                            &uarr;
                                        </span>
                                    }
                                    else
                                    {
                                        <span style="font-weight: bold;" title="Reverse">
                                            &darr;
                                        </span>
                                    }
                                </td>
                                <td>
                                    <SpeedBar CurrentStep="@locoDisplay.Info.CurrentSpeed" MaxSteps="@locoDisplay.Info.SpeedStepsNumeric" />
                                </td>
                                <td>@FormatFunctions(locoDisplay.Info.Functions)</td>
                                <td>@locoDisplay.Timestamp.ToString("HH:mm:ss")</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">Waiting for locomotive data...</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </Content>
</DashboardWindow>

@code {
    private sealed record DisplayLocoInfo(LocoInfo Info, DateTime Timestamp, LocoMode? Mode = null, string? DisplayProtocol = null);

    [Parameter]
    public FirmwareVersion? FirmwareVersion { get; set; }

    [Parameter]
    public EventCallback<MouseEventArgs> OnHeaderMouseDown { get; set; }

    [Parameter]
    public EventCallback OnBringToFront { get; set; }

    private Dictionary<ushort, DisplayLocoInfo> activeLocos = new();
    private bool protocolInLocoInfo => FirmwareVersion?.Version >= Z21FirmwareVersions.V1_43;

    protected override void OnInitialized()
    {
        Z21Client.LocoInfoReceived += OnLocoInfoReceived;
        Z21Client.LocoModeReceived += OnLocoModeReceived;
        LocoMetadataService.OnMetadataUpdated += OnNamesUpdated;
    }

    private async void OnLocoInfoReceived(object? sender, LocoInfo e)
    {
        LocoMode? locoMode = null;
        string? displayProtocol = null;

        if (protocolInLocoInfo)
        {
            locoMode = e.LocomotiveMode;
            displayProtocol = e.DisplayProtocol;
        }

        if (activeLocos.TryGetValue(e.Address, out var existing))
        {
            activeLocos[e.Address] = existing with { Info = e, Timestamp = DateTime.Now, Mode = locoMode, DisplayProtocol = displayProtocol };
        }
        else
        {
            activeLocos[e.Address] = new DisplayLocoInfo(e, DateTime.Now, locoMode, displayProtocol);
        }

        await InvokeAsync(StateHasChanged);
    }

    private async void OnLocoModeReceived(object? sender, LocoModeChangedEventArgs e)
    {
        if (activeLocos.TryGetValue(e.Address, out var existing))
        {
            activeLocos[e.Address] = existing with
            {
                Mode = e.Mode,
                DisplayProtocol = Z21ProtocolName.GetName(e.Mode, existing.Info.NativeSpeedSteps)
            };
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void OnNamesUpdated()
    {
        await InvokeAsync(StateHasChanged);
    }

    private string FormatFunctions(bool[] functions)
    {
        var activeFunctions = new List<string>();
        for (int i = 0; i < functions.Length; i++)
        {
            if (functions[i])
            {
                if (i is 0)
                {
                    activeFunctions.Add("\U0001F4A1");
                }
                else
                {
                    activeFunctions.Add($"F{i}");
                }
            }
        }
        return activeFunctions.Any() ? string.Join(", ", activeFunctions) : "-";
    }

    public void Dispose()
    {
        Z21Client.LocoInfoReceived -= OnLocoInfoReceived;
        Z21Client.LocoModeReceived -= OnLocoModeReceived;
        LocoMetadataService.OnMetadataUpdated -= OnNamesUpdated;
    }
}
