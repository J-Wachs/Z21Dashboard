@*
    Full view of the Z21 system state, including detailed flags decoding.
*@
@using System.Text
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Localization
@using Z21Client.Infrastructure
@using Z21Client
@using Z21Client.Models
@using Z21Dashboard.Application.Interfaces
@using Z21Dashboard.Application.Models
@using Z21Dashboard.Shared.Dashboard.Components
@inject IZ21Client Z21Client
@inject IStringLocalizer<SystemStateFullViewResources> Localizer
@implements IDisposable

<DashboardWindow HeaderTitle="@Localizer["Title"]"
                 OnHeaderMouseDown="OnHeaderMouseDown"
                 OnBringToFront="OnBringToFront">
    <Content>
        <div class="row">
            <div class="col-md-3">
                <table class="table">
                    <tbody>
                        <tr>
                            <td class="text-nowrap">@Localizer["MainCurrent"]</td>
                            <td>
                                @if (_systemState is not null)
                                {
                                    <text>@_systemState?.MainCurrentmA @Localizer["MilliAmpsShort"]</text>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">@Localizer["ProgrammingCurrent"]</td>
                            <td>
                                @if (_systemState is not null)
                                {
                                    @if (HardwareInfo?.HwType is HardwareType.Z21Old or HardwareType.Z21New)
                                    {
                                        <text>@_systemState?.ProgCurrentmA @Localizer["MilliAmpsShort"]</text>
                                    }
                                    else
                                    {
                                        <text>-</text>
                                    }
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">@Localizer["Temperature"]</td>
                            <td class="@_alertTemp text-nowrap">
                                @if (_systemState is not null)
                                {
                                    <text>@_systemState?.TemperatureC °C</text>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">@Localizer["SupplyVoltage"]</td>
                            <td>
                                @if (_systemState is not null)
                                {
                                    <text>@_supplyVoltageV @Localizer["VoltShort"]</text>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="text-nowrap">@Localizer["InternalVoltage"]</td>
                            <td class="@_alertVolt">
                                @if (_systemState is not null)
                                {
                                    <text>@_vccVoltageV @Localizer["VoltShort"]</text>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-3">
                <h5>@Localizer["CentralStateFlags"] (@("0x" + _systemState?.CentralState.ToString("X2")))</h5>
                <pre>@if (_systemState is not null)
                {
                     @DecodeCentralState(_systemState.CentralState)
                }
            </pre>
            </div>
            <div class="col-md-3">
                <h5>@Localizer["ExtendedStateFlags"] (@("0x" + _systemState?.CentralStateEx.ToString("X2")))</h5>
                <pre>@if (_systemState is not null && HardwareInfo is not null)
                {
                     @DecodeCentralStateEx(_systemState.CentralStateEx, HardwareInfo.FwVersion)
                }
            </pre>
            </div>
            @if (HardwareInfo?.FwVersion.Version >= Z21FirmwareVersions.V1_42 && _systemState is not null && _systemState.Capabilities is not null)
            {
                <div class="col-md-3">
                    <h5>@Localizer["CapabilitiesFlags"] (@("0x" + _systemState.Capabilities.Value.ToString("X2")))</h5>
                    <pre>@if (_systemState is not null)
                    {
                         @DecodeCapabilities(_systemState.Capabilities.Value)    
                    }
                    </pre>
                </div>
            }
        </div>
    </Content>
</DashboardWindow>

@code {
    [Parameter]
    public HardwareInfo? HardwareInfo { get; set; }

    /// <summary>
    /// Receives the mousedown event from the parent (Dashboard.razor)
    /// to initiate a drag operation.
    /// </summary>
    [Parameter]
    public EventCallback<MouseEventArgs> OnHeaderMouseDown { get; set; }

    [Parameter]
    public EventCallback OnBringToFront { get; set; }

    private SystemStateChangedEventArgs? _systemState;
    private string _supplyVoltageV => _systemState?.SupplyVoltagemV is not null ? ((decimal)_systemState.SupplyVoltagemV / 1000).ToString("0.0") : "-";
    private string _vccVoltageV => _systemState?.VccVoltagemV is not null ? ((decimal)_systemState.VccVoltagemV / 1000).ToString("0.0") : "-";
    private string _alertTemp = string.Empty;
    private string _alertVolt = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Z21Client.SystemStateChanged += OnSystemStateChanged;
        await Z21Client.GetSystemStateAsync();
    }

    private async void OnSystemStateChanged(object? sender, SystemStateChangedEventArgs e)
    {
        _systemState = e;

        _alertVolt = ((e.CentralState & SystemStateChangedEventArgs.CentralStateShortCircuit) > 0) ? "alertfield" : string.Empty;
        _alertTemp = ((e.CentralStateEx & SystemStateChangedEventArgs.CentralStateExHighTemperature) > 0) ? "alertfield" : string.Empty;

        await InvokeAsync(StateHasChanged);
    }

    private string MakeFixedLengthString(string text, int len)
    {
        if (text.Length < len)
        {
            text = text + new String(' ', len - text.Length);
        }
        return text;
    }

    private string DecodeCentralState(byte state)
    {
        var sb = new StringBuilder();
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["EmergencyStop"] + ":", 20)} {((state & SystemStateChangedEventArgs.CentralStateEmergencyStop) > 0 ? Localizer["On"] : Localizer["Off"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["TrackVoltage"] + ":", 20)} {((state & SystemStateChangedEventArgs.CentralStateTrackVoltageOff) > 0 ? Localizer["Off"] : Localizer["On"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["ShortCircuit"] + ":", 20)} {((state & SystemStateChangedEventArgs.CentralStateShortCircuit) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["ProgrammingMode"] + ":", 20)} {((state & SystemStateChangedEventArgs.CentralStateProgrammingMode) > 0 ? Localizer["On"] : Localizer["Off"])}"
        );
        return sb.ToString();
    }

    private string DecodeCentralStateEx(byte stateEx, FirmwareVersion? fw)
    {
        var sb = new StringBuilder();
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["HighTemperature"] + ":", 20)} {((stateEx & SystemStateChangedEventArgs.CentralStateExHighTemperature) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["PowerLost"] + ":", 20)} {((stateEx & SystemStateChangedEventArgs.CentralStateExPowerLost) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["ShortCircuitExt"] + ":", 20)} {((stateEx & SystemStateChangedEventArgs.CentralStateExShortCircuitExternal) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["ShortCircuitInt"] + ":", 20)} {((stateEx & SystemStateChangedEventArgs.CentralStateExShortCircuitInternal) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );

        if (fw?.Version >= Z21FirmwareVersions.V1_42)
        {
            sb.AppendLine($"{MakeFixedLengthString(Localizer["RCN213Mode"] + ":", 20)} {((stateEx & SystemStateChangedEventArgs.CentralStateExRcn213Mode) > 0 ? Localizer["Active"] : Localizer["Inactive"])}");
        }
        return sb.ToString();
    }

    private string DecodeCapabilities(byte capabilities)
    {
        var sb = new StringBuilder();
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["Protocols"] + ":", 20)} {((capabilities & SystemStateChangedEventArgs.CapabilitiesDcc) > 0 ? "DCC " : string.Empty)}{((capabilities & SystemStateChangedEventArgs.CapabilitiesDcc) > 0 ? "MM" : string.Empty)}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["RailCom"] + ":", 20)} {((capabilities & SystemStateChangedEventArgs.CapabilitiesRailCom) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["AcceptLANLocoCmds"] + ":", 20)} {((capabilities & SystemStateChangedEventArgs.CapabilitiesLocoCmds) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["AcceptLANAccCmds"] + ":", 20)} {((capabilities & SystemStateChangedEventArgs.CapabilitiesAccessoryCmds) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["AcceptLANDetCmds"] + ":", 20)} {((capabilities & SystemStateChangedEventArgs.CapabilitiesDetectorCmds) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        sb.AppendLine(
            $"{MakeFixedLengthString(Localizer["NeedsUnlockCode"] + ":", 20)} {((capabilities & SystemStateChangedEventArgs.CapabilitiesNeedsUnlockCode) > 0 ? Localizer["Yes"] : Localizer["No"])}"
        );
        return sb.ToString();
    }

    public void Dispose()
    {
        Z21Client.SystemStateChanged -= OnSystemStateChanged;
    }
}
