@* 
    This is the main dashboard component for the Z21Dashboard application.
    It manages the connection state to the Z21 device and displays
    relevant information and controls based on that state.
*@
@using Microsoft.Extensions.Localization
@using Z21Client.Interfaces
@using Z21Client.Models
@using Z21Dashboard.Application.Interfaces
@using Z21Dashboard.Application.Models
@using Z21Dashboard.Shared.Dashboard.Components
@using Z21Status.Application.Interfaces
@inject IZ21Client Z21Client
@inject IStringLocalizer<DashboardResources> Localizer
@inject IDocumentationService DocumentationService
@implements IAsyncDisposable

<!-- Global Settings Button -->
<div class="d-flex" style="position: fixed; top: 1rem; right: 1rem; z-index: 1050; gap: 0.5rem;">
    <button class="btn btn-lg btn-secondary d-flex align-items-center justify-content-center"
            onclick="@OpenDocumentation"
            title="@Localizer["Help"]"
            style="width: 45px; height: 45px; padding: 0;">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="yellow" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-1.057 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c.61 0 1.029-.394 1.029-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94 0 .533.425.927 1.01.927z" />
        </svg>
    </button>

    <button class="btn btn-lg btn-secondary" onclick="@OpenSettingsModal" title="@Localizer["Settings"]">
        &#9881; <!-- Gear Icon -->
    </button>
</div>

<div class="container-fluid">
    <!-- Styling classes to create a visually distinct control area -->
    <div class="row bg-light border border-secondary rounded p-3 mb-3">
        <ConnectionView ConnectionState="_connectionState" OnConnect="Connect" OnDisconnect="Disconnect" />
        <About />
    </div>

    @if (_connectionState is ConnectionState.Connected)
    {
        // The entire static layout has been replaced by our new dynamic Dashboard component.
        // We pass the HardwareInfo down, so it can be distributed to the child components as needed.
        <Viewport HardwareInfo="_hardwareInfo" Z21Code="_z21Code" />
    }
</div>

<!-- Settings Modal -->
@if (_isSettingsModalOpen)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show" tabindex="-1" style="display: block;">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer["EditDashboardSettings"]</h5>
                    <button type="button" class="btn-close" onclick="@CloseSettingsModal" aria-label="@Localizer["Close"]"></button>
                </div>
                <div class="modal-body">
                    <DashboardSettings />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="@CloseSettingsModal">@Localizer["Close"]</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    private BroadcastFlagsChangedEventArgs? _broadcastFlags;
    private HardwareInfo? _hardwareInfo;
    private Z21Code? _z21Code;
    private ConnectionState _connectionState = ConnectionState.Disconnected;

    // --- NEW: State for settings modal ---
    private bool _isSettingsModalOpen = false;

    private void OpenSettingsModal()
    {
        _isSettingsModalOpen = true;
        StateHasChanged();
    }

    private void CloseSettingsModal()
    {
        _isSettingsModalOpen = false;
        StateHasChanged();
    }
    // ------------------------------------

    private async Task Connect(string ipAddress)
    {
        _connectionState = ConnectionState.Connecting;
        _broadcastFlags = null;
        _hardwareInfo = null;

        SubscribeToEvents();
        bool success = await Z21Client.ConnectAsync(ipAddress);
        if (success)
        {
            _connectionState = ConnectionState.Connected;
            await Z21Client.GetSerialNumberAsync();
            await Z21Client.GetHardwareInfoAsync();
            await Z21Client.GetZ21CodeAsync();
        }
        else
        {
            _connectionState = ConnectionState.Disconnected;
            UnsubscribeFromEvents();
        }
    }

    private async Task Disconnect()
    {
        await Z21Client.DisconnectAsync();
        UnsubscribeFromEvents();

        _broadcastFlags = null;
        _hardwareInfo = null;

        _connectionState = ConnectionState.Disconnected;
    }

    private void SubscribeToEvents()
    {
        Z21Client.ConnectionStateChanged += OnConnectionStateChanged;
        Z21Client.BroadcastFlagsReceived += OnBroadcastFlagsReceived;
        Z21Client.HardwareInfoReceived += OnHardwareInfoReceived;
        Z21Client.Z21CodeReceived += OnZ21CodeReceived;
    }

    private void UnsubscribeFromEvents()
    {
        Z21Client.ConnectionStateChanged -= OnConnectionStateChanged;
        Z21Client.BroadcastFlagsReceived -= OnBroadcastFlagsReceived;
        Z21Client.HardwareInfoReceived -= OnHardwareInfoReceived;
        Z21Client.Z21CodeReceived -= OnZ21CodeReceived;
    }

    private async Task GetBroadcastFlags()
    {
        _broadcastFlags = null;
        await Z21Client.GetBroadcastFlagsAsync();
    }

    private async void OnConnectionStateChanged(object? sender, ConnectionStateChangedEventArgs e)
    {
        _connectionState = e.State;
        if (_connectionState is ConnectionState.Lost)
        {
            UnsubscribeFromEvents();
        }
        await InvokeAsync(StateHasChanged);
    }

    private async void OnBroadcastFlagsReceived(object? sender, BroadcastFlagsChangedEventArgs e)
    {
        _broadcastFlags = e;
        await InvokeAsync(StateHasChanged);
    }

    private async void OnHardwareInfoReceived(object? sender, HardwareInfo e)
    {
        _hardwareInfo = e;
        await InvokeAsync(StateHasChanged);
    }

    private async void OnZ21CodeReceived(object? sender, Z21Code e)
    {
        _z21Code = e;
        await InvokeAsync(StateHasChanged);
        // Unsubscribe as we now have the result.
        Z21Client.Z21CodeReceived -= OnZ21CodeReceived;
    }

    private async Task OpenDocumentation()
    {
        await DocumentationService.OpenManualAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (_connectionState is not ConnectionState.Disconnected)
        {
            await Disconnect();
        }
        UnsubscribeFromEvents();
    }
}
