@*
    Component for managing and displaying the connection status to a Z21 device.
*@
@using System.Net
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Localization
@using Z21Client
@using Z21Client.Models
@using Z21Dashboard.Application.Interfaces
@using Z21Dashboard.Application.Models
@using Z21Dashboard.Shared.Dashboard.Components
@inject IAppDataService AppDataService
@inject IStringLocalizer<ConnectionResources> Localizer
@inject IZ21Client Z21Client
@implements IDisposable

<DashboardWindow HeaderTitle="@Localizer["Title"]"
                 OnHeaderMouseDown="OnHeaderMouseDown"
                 OnBringToFront="OnBringToFront">
    <HeaderContent>
        @if (ConnectionState is ConnectionState.Connected)
        {
            if (_hardwareInfo is not null)
            {
                <span class="badge bg-info">
                    @_hardwareInfo.HwType, @if (_z21Code is not null)
                    {
                        <text>@Z21CodeText, </text>
                    }
                    @if (_serialNumber is not null)
                    {
                        <text>@Localizer["SN"]: @_serialNumber.Value, </text>
                    }

                    @Localizer["FW"]: @_hardwareInfo.FwVersion
                </span>
                <text>&nbsp;</text>
            }
        }
        <span class="badge @GetConnectionStatusClass()">@Localizer[ConnectionState.ToString()]</span>
    </HeaderContent>

    <Content>
        <div class="row g-2">
            <!-- Left Column -->
            <div class="col-6">
                <div class="input-group mb-2">
                    <input class="form-control" value="@_ipAddress" onchange="@OnIpAddressChanged" disabled="@(ConnectionState != ConnectionState.Disconnected)" placeholder="Enter IP" />
                </div>

                @if (ConnectionState == ConnectionState.Connected)
                {
                    <button class="btn btn-danger w-100" onclick="@Disconnect">@Localizer["Disconnect"]</button>
                }
                else
                {
                    <button class="btn btn-success w-100" onclick="@Connect" disabled="@(ConnectionState == ConnectionState.Connecting || string.IsNullOrWhiteSpace(_ipAddress))">
                        @if (ConnectionState == ConnectionState.Connecting)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span class="ms-1">@Localizer["Connecting"]...</span>
                        }
                        else
                        {
                            <span>@Localizer["Connect"]</span>
                        }
                    </button>
                }
            </div>

            <!-- Right Column -->
            <div class="col-6">
                <div class="btn-group w-100 mb-2" role="group">
                    <button class="btn @(_trackPowerState == TrackPowerState.On ? "btn-success" : "btn-outline-success")"
                            onclick="@SetTrackPowerOn" disabled="@(ConnectionState != ConnectionState.Connected)">
                        @Localizer["TrackPwrOn"]
                    </button>
                    <button class="btn @(_trackPowerState == TrackPowerState.Off ? "btn-secondary" : "btn-outline-secondary")"
                            onclick="@SetTrackPowerOff" disabled="@(ConnectionState != ConnectionState.Connected)">
                        @Localizer["TrackPwrOff"]
                    </button>
                </div>

                <button class="btn btn-danger w-100" onclick="@SetEmergencyStop" disabled="@(ConnectionState != ConnectionState.Connected)">
                    @Localizer["EmergencyStop"]
                </button>
            </div>
        </div>

        @if (ConnectionState == ConnectionState.Lost)
        {
            <div class="alert alert-danger mt-3 mb-0" role="alert">
                @Localizer["ConnectionLost"]
            </div>
        }
    </Content>
</DashboardWindow>

@code {
    [Parameter]
    public EventCallback<MouseEventArgs> OnHeaderMouseDown { get; set; }

    [Parameter]
    public EventCallback OnBringToFront { get; set; }

    [Parameter]
    public ConnectionState ConnectionState { get; set; } = ConnectionState.Disconnected;

    [Parameter]
    public EventCallback<string> OnConnect { get; set; }

    [Parameter]
    public EventCallback OnDisconnect { get; set; }

    private const string Z21IpAddressKey = "Z21Connection_IpAddress";
    private string _ipAddress { get; set; } = string.Empty;

    private SerialNumber? _serialNumber;
    private HardwareInfo? _hardwareInfo;
    private Z21Code? _z21Code;
    private TrackPowerState? _trackPowerState;
    private ConnectionState _prevConnectionState = ConnectionState.Disconnected;

    protected override void OnInitialized()
    {
        var savedIp = AppDataService.GetData<string>(Z21IpAddressKey);

        if (!string.IsNullOrWhiteSpace(savedIp))
        {
            _ipAddress = savedIp;
        }
        else
        {
            _ipAddress = "192.168.0.111";
            AppDataService.SaveData(Z21IpAddressKey, _ipAddress);
        }
    }

    private void OnIpAddressChanged(ChangeEventArgs e)
    {
        var newIp = e.Value?.ToString() ?? string.Empty;
        if (_ipAddress != newIp)
        {
            _ipAddress = newIp;
            AppDataService.SaveData(Z21IpAddressKey, _ipAddress);
        }
    }

    private string Z21CodeText => _z21Code?.LockState switch
    {
        Z21LockState.NoLock => Localizer["Nolock"],
        Z21LockState.Locked => Localizer["Locked"],
        Z21LockState.Unlocked => Localizer["Unlocked"],
        _ => string.Empty
    };

    private async Task Connect()
    {
        await OnConnect.InvokeAsync(_ipAddress);
      
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Due to the fact that we in Connect is in the process of connecting, we
        // do not have information about if we did succeed or not. Therefore, we 
        // check here for a change in connection state to Connected to perform
        if (ConnectionState != _prevConnectionState && ConnectionState is ConnectionState.Connected)
        {
            SubscribeToEvents();
            
            await Z21Client.GetZ21CodeAsync();
            await Z21Client.GetHardwareInfoAsync();
            await Z21Client.GetSerialNumberAsync();
            // This call is to trigger the initial state of the track power.
            await Z21Client.GetSystemStateAsync();

        }
        _prevConnectionState = ConnectionState;

        await base.OnParametersSetAsync();
    }

    private async Task Disconnect()
    {
        await OnDisconnect.InvokeAsync();
        UnsubscribeFromEvents();
    }

    private async Task SetTrackPowerOn() => await Z21Client.SetTrackPowerOnAsync();
    private async Task SetTrackPowerOff() => await Z21Client.SetTrackPowerOffAsync();
    private async Task SetEmergencyStop() => await Z21Client.SetEmergencyStopAsync();

    private string GetConnectionStatusClass() => ConnectionState switch
    {
        ConnectionState.Connected => "bg-success",
        ConnectionState.Connecting => "bg-secondary",
        ConnectionState.Lost => "bg-danger",
        _ => "bg-secondary"
    };

    private void SubscribeToEvents()
    {
        Z21Client.HardwareInfoReceived += OnHardwareInfoReceived;
        Z21Client.SerialNumberReceived += OnSerialNumberReceived;
        Z21Client.Z21CodeReceived += OnZ21CodeReceived;
        Z21Client.TrackPowerInfoReceived += OnTrackPowerInfoReceived;
        Z21Client.EmergencyStopReceived += OnEmergencyStopReceived;
        Z21Client.SystemStateChanged += OnSystemStateChanged;
    }

    private void UnsubscribeFromEvents()
    {
        Z21Client.HardwareInfoReceived -= OnHardwareInfoReceived;
        Z21Client.SerialNumberReceived -= OnSerialNumberReceived;
        Z21Client.Z21CodeReceived -= OnZ21CodeReceived;
        Z21Client.TrackPowerInfoReceived -= OnTrackPowerInfoReceived;
        Z21Client.EmergencyStopReceived -= OnEmergencyStopReceived;
        Z21Client.SystemStateChanged -= OnSystemStateChanged; // Ensure cleanup here too
    }

    private async void OnHardwareInfoReceived(object? sender, HardwareInfo e)
    {
        _hardwareInfo = e;
        // We do not need repeated updates for this event
        Z21Client.HardwareInfoReceived -= OnHardwareInfoReceived; // One-time event
        await InvokeAsync(StateHasChanged);
    }
    private async void OnSerialNumberReceived(object? sender, SerialNumber e)
    {
        _serialNumber = e;
        // We do not need repeated updates for this event
        Z21Client.SerialNumberReceived -= OnSerialNumberReceived; // One-time event
        await InvokeAsync(StateHasChanged);
    }
    private async void OnZ21CodeReceived(object? sender, Z21Code e)
    {
        _z21Code = e;
        // We do not need repeated updates for this event
        Z21Client.Z21CodeReceived -= OnZ21CodeReceived; // One-time event
        await InvokeAsync(StateHasChanged);
    }

    // This handler will continue to receive live updates
    private async void OnTrackPowerInfoReceived(object? sender, TrackPowerInfo e)
    {
        _trackPowerState = e.State;
        await InvokeAsync(StateHasChanged);
    }

    private async void OnEmergencyStopReceived(object? sender, EventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    // --- Event handler for initial System State ---
    private async void OnSystemStateChanged(object? sender, SystemStateChangedEventArgs e)
    {
        // Unsubscribe immediately as we only need the initial state.
        Z21Client.SystemStateChanged -= OnSystemStateChanged;

        _trackPowerState = (e.CentralState & SystemStateChangedEventArgs.CentralStateTrackVoltageOff) > 0
        ? TrackPowerState.Off
        : TrackPowerState.On;

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UnsubscribeFromEvents();
    }
}
